<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ink Insights â€” Loading</title>
  <link rel="icon" href="assests/Ink-logo.png" type="image/png" />

  <style>
    :root {
      --teal: #005A63;
      --green: #517A06;
      --blue: #00A6FF;
      --white: #fff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      background: #0a0f1a;
      color: var(--white);
      font-family: "Droid Serif", Georgia, serif;
      overflow: hidden;
    }

    #stars {
      position: fixed;
      inset: 0;
      z-index: 0;
      display: block;
    }

    .wrap {
      position: relative;
      z-index: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 28px;
    }

    .title {
      font-family: "Rockwell", "Courier New", Courier, Georgia, serif;
      font-weight: 700;
      font-size: clamp(40px, 6vw, 88px);
      text-shadow: 0 8px 18px rgba(0, 0, 0, .4);
    }

    .dots {
      display: inline-flex;
      gap: 6px;
      margin-left: 6px;
    }

    .dot {
      width: .45em;
      height: .45em;
      border-radius: 50%;
      background: #fff;
      opacity: .45;
      animation: bob 1.2s infinite ease-in-out;
    }

    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }

    @keyframes bob {
      0%, 100% { transform: translateY(0); opacity: .45; }
      50% { transform: translateY(-6px); opacity: .95; }
    }

    .progress {
      width: min(700px, 90vw);
      background: rgba(255, 255, 255, .06);
      border: 2px dashed rgba(255, 255, 255, .25);
      border-radius: 18px;
      padding: 16px;
      backdrop-filter: blur(2px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .3) inset;
    }

    .bar {
      height: 18px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .08);
      overflow: hidden;
      position: relative;
    }

    .fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--blue), var(--green));
      border-radius: 12px;
      box-shadow: 0 0 14px rgba(0, 166, 255, .5);
      transition: width .2s ease;
    }

    .fill::after {
      content: "";
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, .15) 0 10px,
        transparent 10px 22px
      );
      mix-blend-mode: overlay;
    }

    .load-msg {
      margin-top: 10px;
      font-style: italic;
      color: #BBD3C4;
      font-size: 1.1rem;
      text-shadow: 0 4px 12px rgba(0, 0, 0, .3);
      min-height: 1.4em;
      transition: opacity .4s ease;
    }

    .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      color: rgba(255, 255, 255, .85);
      font-family: "Rockwell", "Courier New", Courier, Georgia, serif;
    }

    .pct {
      font-weight: 700;
      letter-spacing: .5px;
    }

    .tagline {
      font-style: italic;
      color: #BBD3C4;
      font-size: clamp(16px, 2.6vw, 24px);
      text-shadow: 0 4px 12px rgba(0, 0, 0, .3);
    }
  </style>
</head>

<body>
  <canvas id="stars"></canvas>

  <main class="wrap">
    <h1 class="title">
      Loading
      <span class="dots">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </span>
    </h1>

    <section class="progress">
      <div class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="fill" class="fill"></div>
      </div>

      <div class="meta">
        <div>Preparing your dashboardâ€¦</div>
        <div class="pct" id="pct">0%</div>
      </div>

      <p class="load-msg" id="loadMsg">Initializing magic...</p>
    </section>

    <p class="tagline">Brew some tea while we unravel your storyâ€¦</p>
  </main>

<script>
/* ========= STARFIELD ========= */
(function() {
  const canvas = document.getElementById('stars');
  const ctx = canvas.getContext('2d');
  let W, H, stars = [];

  function resize() {
    W = canvas.width = innerWidth;
    H = canvas.height = innerHeight;
  }

  window.addEventListener('resize', () => { resize(); makeStars(); });

  function rand(a, b) { return Math.random() * (b - a) + a; }

  function makeStars() {
    stars = Array.from({ length: 160 }, () => ({
      x: rand(0, W),
      y: rand(0, H),
      r: rand(0.4, 1.5),
      s: rand(0.5, 1.5)
    }));
  }

  function draw(t) {
    ctx.clearRect(0, 0, W, H);
    for (const s of stars) {
      const a = (Math.sin(t * 0.002 * s.s) + 1) / 2 * 0.6 + 0.3;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255,255,255,${a})`;
      ctx.fill();
    }
    requestAnimationFrame(draw);
  }

  resize();
  makeStars();
  requestAnimationFrame(draw);
})();

/* ========= LOADING PROGRESS & BACKEND HANDLER ========= */
(async function() {
  const fill = document.getElementById('fill');
  const pct = document.getElementById('pct');
  const bar = document.querySelector('.bar');
  const duration = 18000;
  const start = performance.now();
  let apiDone = false;
  let progress = 0;

  function easeInOutCubic(x) {
    return x < 0.5 ? 4 * x * x * x : 1 - Math.pow(-2 * x + 2, 3) / 2;
  }

  function step(ts) {
    const p = Math.min((ts - start) / duration, 1);
    const eased = easeInOutCubic(p);
    progress = Math.floor(eased * 100);
    fill.style.width = progress + "%";
    pct.textContent = progress + "%";
    bar.setAttribute("aria-valuenow", progress);

    if (p < 1) requestAnimationFrame(step);
    else if (apiDone) finish();
  }
  requestAnimationFrame(step);

  // === Retrieve stored text/meta ===
  const meta = JSON.parse(localStorage.getItem("ink_report_meta") || "{}");
  const text = localStorage.getItem("ink_text") || "";
  let data = JSON.parse(localStorage.getItem("ink_report") || "null");

  if (!text) {
    alert("No text found. Please upload your file again.");
    window.location.href = "upload.html";
    return;
  }

  // === Skip API if cached ===
  if (data) {
    console.log("âœ… Using cached analysis (ink_report).");
    apiDone = true;
    if (progress >= 100) finish();
    else setTimeout(finish, 1200);
    return;
  }

  // === Otherwise, fetch backend ===
  try {
    console.log("ðŸš€ Sending text to backend...");
    const res = await fetch("https://ink-insights-backend.onrender.com/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text, filename: meta.name || "document.txt" })
    });

    if (!res.ok) throw new Error("Backend returned " + res.status);

    data = await res.json();
    localStorage.setItem("ink_report", JSON.stringify(data));
    apiDone = true;

    if (progress >= 100) finish();
  } catch (err) {
    console.error(err);
    alert("âš ï¸ Could not connect to analysis engine. Please try again.");
    window.location.href = "upload.html";
  }

  function finish() {
    setTimeout(() => window.location.href = "dashboard.html", 800);
  }
})();

/* ========= ROTATING MESSAGES ========= */
(function() {
  const messages = [
    "Analyzing your literary patterns...",
    "Mapping emotions and tone shifts...",
    "Extracting key themes and motifs...",
    "Almost ready â€” polishing insights..."
  ];
  const msgEl = document.getElementById('loadMsg');
  let i = 0;

  function cycle() {
    msgEl.style.opacity = 0;
    setTimeout(() => {
      msgEl.textContent = messages[i];
      msgEl.style.opacity = 1;
      i = (i + 1) % messages.length;
    }, 400);
  }

  cycle();
  setInterval(cycle, 4000);
})();
</script>


</body>
</html>
